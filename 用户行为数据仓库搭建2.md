# 第一章  数仓分层概念

## 1 项目数仓分层详细表介绍



![数据仓库分层](https://github.com/xzt1995/Data-Warehouse/blob/master/img/%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E4%BB%93%E6%90%AD%E5%BB%BA/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E5%88%86%E5%B1%82.png)



不同公司对于数仓的命名可能有所区别，但具体的理念都是相通的，数据层级越高，数据量越少。



![ods,dwd](https://github.com/xzt1995/Data-Warehouse/blob/master/img/%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E4%BB%93%E6%90%AD%E5%BB%BA/ods%2Cdwd.png)



![dws.ads](https://github.com/xzt1995/Data-Warehouse/blob/master/img/%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E4%BB%93%E6%90%AD%E5%BB%BA/dws.ads.png)





​	以上就是我们这个项目所涉及到的表明细，大部分电商项目都有以上的表，可以计算出大部分场景下我们需要的需求。本章我们会详细介绍如何创建上述的数据仓库。



## 2 数仓命名规范

Ø  ODS层命名为ods

Ø  DWD层命名为dwd

Ø  DWS层命名为dws

Ø  ADS层命名为ads

Ø  临时表数据库命名为xxx_tmp

Ø  备份数据数据库命名为xxx_bak



# 第2章  数仓搭建环境准备



![系统流程设计](https://github.com/xzt1995/Data-Warehouse/blob/master/img/%E7%B3%BB%E7%BB%9F%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1.png)



hive的作用是对HDFS中的元数据进行分析，创建HIVE表格，为后续的需求提供数据支持。



集群规划：

|       | 服务器hadoop102 | 服务器hadoop103 | 服务器hadoop104 |
| ----- | ------------ | ------------ | ------------ |
| Hive  | Hive         |              |              |
| MySQL | MySQL        |              |              |



## 1  Hive&MySQL安装

### 1.1 Hive安装及配置

下载地址：<http://archive.apache.org/dist/hive/hive-1.2.1/>

（1）把apache-hive-1.2.1-bin.tar.gz上传到linux的/opt/software目录下

（2）解压apache-hive-1.2.1-bin.tar.gz到/opt/module/目录下面

```
[xzt@hadoop102 software]$tar -zxvf apache-hive-1.2.1-bin.tar.gz -C /opt/module/
```

（3）修改apache-hive-1.2.1-bin.tar.gz的名称为hive

```
[xzt@hadoop102 module]$ mv apache-hive-1.2.1-bin/ hive
```

（4）修改/opt/module/hive/conf目录下的hive-env.sh.template名称为hive-env.sh

```
[xzt@hadoop102 conf]$ mv hive-env.sh.template hive-env.sh
```

（5）配置hive-env.sh文件

​        （a）配置HADOOP_HOME路径

```
export HADOOP_HOME=/opt/module/hadoop-2.7.2
```

​        （b）配置HIVE_CONF_DIR路径

```
export HIVE_CONF_DIR=/opt/module/hive/conf
```

2．Hadoop集群配置

（1）必须启动HDFS和YARN

```
[xzt@hadoop102hadoop-2.7.2]$ sbin/start-dfs.sh

[xzt@hadoop103hadoop-2.7.2]$ sbin/start-yarn.sh
```

（2）在HDFS上创建/tmp和/user/hive/warehouse两个目录并修改他们的同组权限可写

```
[xzt@hadoop102hadoop-2.7.2]$ bin/hadoop fs -mkdir /tmp

[xzt@hadoop102hadoop-2.7.2]$ bin/hadoop fs -mkdir -p /user/hive/warehouse

 

[xzt@hadoop102hadoop-2.7.2]$ bin/hadoop fs -chmod g+w /tmp

[xzt@hadoop102hadoop-2.7.2]$ bin/hadoop fs -chmod g+w /user/hive/warehouse

```

### 1.2 mysql安装

### 1.2.1 mysql 服务器和客户端安装

步骤省略

### 1.2.2 MySql中user表中主机配置

配置只要是root用户+密码，在任何主机上都能登录MySQL数据库。

1．进入mysql

```
[root@hadoop102 mysql-libs]#mysql -uroot -p000000
```

2．显示数据库

```
mysql>show databases;
```

3．使用mysql数据库

```
mysql>use mysql;
```

4．展示mysql数据库中的所有表

```
mysql>show tables;
```

5．展示user表的结构

```
mysql>desc user;
```

6．查询user表

```
mysql>select User, Host,Password from user;
```

7．修改user表，把Host表内容修改为%

```
mysql>update user sethost='%' where host='localhost';
```

8．删除root用户的其他host

```
mysql>

delete from user whereHost='hadoop102';

delete from user whereHost='127.0.0.1';

delete from user whereHost='::1';

```

9．刷新

```
mysql>flush privileges;
```

10．退出

```
mysql>quit;
```

### 1.2.3 Hive元数据配置到MySql

#### 1.2.3.1 驱动拷贝

1．解压mysql-connector-java-5.1.27.tar.gz驱动包**（git目录下的jar文件夹下有）**

```
[root@hadoop102 mysql-libs]# tar -zxvf mysql-connector-java-5.1.27.tar.gz
```

2．拷贝/opt/software/mysql-libs/mysql-connector-java-5.1.27目录下的mysql-connector-java-5.1.27-bin.jar到/opt/module/hive/lib/

```
[root@hadoop102 mysql-connector-java-5.1.27]# cp mysql-connector-java-5.1.27-bin.jar
 /opt/module/hive/lib/
```

#### 2.5.2 配置Metastore到MySql

1．在/opt/module/hive/conf目录下创建一个hive-site.xml**(切回自己的用户，不要用root)**

```
[xzt@hadoop102 conf]$ vi hive-site.xml
```

2．根据官方文档配置参数，拷贝数据到hive-site.xml文件中

<https://cwiki.apache.org/confluence/display/Hive/AdminManual+MetastoreAdmin>

```
<?xml version="1.0"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>
	<property>
	  <name>javax.jdo.option.ConnectionURL</name>
	  <value>jdbc:mysql://hadoop102:3306/metastore?createDatabaseIfNotExist=true</value>
	  <description>JDBC connect string for a JDBC metastore</description>
	</property>

	<property>
	  <name>javax.jdo.option.ConnectionDriverName</name>
	  <value>com.mysql.jdbc.Driver</value>
	  <description>Driver class name for a JDBC metastore</description>
	</property>

	<property>
	  <name>javax.jdo.option.ConnectionUserName</name>
	  <value>root</value>
	  <description>username to use against metastore database</description>
	</property>

	<property>
	  <name>javax.jdo.option.ConnectionPassword</name>
	  <value>000000</value>  （000000要设置成你自己的mysql密码）
	  <description>password to use against metastore database</description>
	</property>
</configuration>

```

### 1.2.4 查询后信息显示配置

1）在hive-site.xml文件中添加如下配置信息，就可以实现显示当前数据库，以及查询表的头信息配置。

```
<property>
	<name>hive.cli.print.header</name>
	<value>true</value>
</property>

<property>
	<name>hive.cli.print.current.db</name>
	<value>true</value>
</property>

```

2） 关闭元数据检查

同样是在hive-site.xml文件中追加如下配置。

**企业开发中不需要配置该参数，因为我们用的是自己的电脑，性能比服务器要差很多，所以这边关掉这个功能可以防止电脑资源不足。**

```
<property>
    <name>hive.metastore.schema.verification</name>
    <value>false</value>
</property>

```

## 2 Hive运行引擎Tez

Tez是一个Hive的运行引擎，性能优于MR。为什么优于MR呢？看下图。

![tez](https://github.com/xzt1995/Data-Warehouse/blob/master/img/%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E4%BB%93%E6%90%AD%E5%BB%BA/tez.png)

​	用Hive直接编写MR程序，假设有四个有依赖关系的MR作业，上图中，绿色是Reduce Task，云状表示写屏蔽，需要将中间结果持久化写到HDFS。

​	Tez可以将多个有依赖的作业转换为一个作业，这样只需写一次HDFS，且中间节点较少，从而大大提升作业的计算性能。

### 2.1 安装包准备

1）下载tez的依赖包：<http://tez.apache.org>

2）拷贝apache-tez-0.9.1-bin.tar.gz到hadoop102的/opt/module目录

3）解压缩apache-tez-0.9.1-bin.tar.gz

4）修改名称

```
[xzt@hadoop102module]$ mv apache-tez-0.9.1-bin/ tez-0.9.1
```

### 2.2 在Hive中配置Tez 

1）进入到Hive的配置目录：/opt/module/hive/conf

2）在hive-env.sh文件中添加tez环境变量配置和依赖包环境变量配置

添加如下配置

```
# Set HADOOP_HOME to point to a specific hadoop install directory
export HADOOP_HOME=/opt/module/hadoop-2.7.2

# Hive Configuration Directory can be controlled by:
export HIVE_CONF_DIR=/opt/module/hive/conf

# Folder containing extra libraries required for hive compilation/execution can be controlled by:
export TEZ_HOME=/opt/module/tez-0.9.1    #是你的tez的解压目录
export TEZ_JARS=""
for jar in `ls $TEZ_HOME |grep jar`; do
    export TEZ_JARS=$TEZ_JARS:$TEZ_HOME/$jar
done
for jar in `ls $TEZ_HOME/lib`; do
    export TEZ_JARS=$TEZ_JARS:$TEZ_HOME/lib/$jar
done

export HIVE_AUX_JARS_PATH=/opt/module/hadoop-2.7.2/share/hadoop/common/hadoop-lzo-0.4.20.jar$TEZ_JARS

```

3）在hive-site.xml文件中添加如下配置，更改hive计算引擎

```
<property>

	<name>hive.execution.engine</name>

    <value>tez</value>

</property>

```

### 2.3 配置Tez

1）在Hive的/opt/module/hive/conf下面创建一个tez-site.xml文件

添加如下内容

```
<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="configuration.xsl"?>
<configuration>
<property>
	<name>tez.lib.uris</name>    <value>${fs.defaultFS}/tez/tez-0.9.1,${fs.defaultFS}/tez/tez-0.9.1/lib</value>
</property>
<property>
	<name>tez.lib.uris.classpath</name>    	<value>${fs.defaultFS}/tez/tez-0.9.1,${fs.defaultFS}/tez/tez-0.9.1/lib</value>
</property>
<property>
     <name>tez.use.cluster.hadoop-libs</name>
     <value>true</value>
</property>
<property>
     <name>tez.history.logging.service.class</name>        <value>org.apache.tez.dag.history.logging.ats.ATSHistoryLoggingService</value>
</property>
</configuration>

```

### 2.4 上传Tez到集群

1）将/opt/module/tez-0.9.1上传到HDFS的/tez路径

```
[xzt@hadoop102 conf]$ hadoop fs -mkdir /tez
[xzt@hadoop102 conf]$ hadoop fs -put /opt/module/tez-0.9.1/ /tez
[xzt@hadoop102 conf]$ hadoop fs -ls /tez
/tez/tez-0.9.1

```

### 2.5 测试

1）启动Hive

```
[xzt@hadoop102 hive]$ bin/hive
```

2）创建LZO表

```
hive (default)> create table student(
id int,
name string);
```

3）向表中插入数据

```
hive (default)> insert into student values(1,"zhangsan");
```

4）如果没有报错就表示成功了

### 2.6 问题分析

运行Tez时检查到用过多内存而被NodeManager杀死进程问题：

```
Caused by: org.apache.tez.dag.api.SessionNotRunning: TezSession has already shutdown. Application application_1546781144082_0005 failed 2 times due to AM Container for appattempt_1546781144082_0005_000002 exited with  exitCode: -103
For more detailed output, check application tracking page:http://hadoop103:8088/cluster/app/application_1546781144082_0005Then, click on links to logs of each attempt.
Diagnostics: Container [pid=11116,containerID=container_1546781144082_0005_02_000001] is running beyond virtual memory limits. Current usage: 216.3 MB of 1 GB physical memory used; 2.6 GB of 2.1 GB virtual memory used. Killing container.

```

这种问题是从机上运行的Container试图使用过多的内存，而被NodeManager kill掉了。

```
[摘录] The NodeManager is killing your container. It sounds like you are trying to use hadoop streaming which is running as a child process of the map-reduce task. The NodeManager monitors the entire process tree of the task and if it eats up more memory than the maximum set in mapreduce.map.memory.mb or mapreduce.reduce.memory.mb respectively, we would expect the Nodemanager to kill the task, otherwise your task is stealing memory belonging to other containers, which you don't want.
```

方案一：或者是关掉虚拟内存检查。我们选这个，修改yarn-site.xml

**修改完要分发一下集群，然后重启Hadoop**

```
<property>
<name>yarn.nodemanager.vmem-check-enabled</name>
<value>false</value>
</property>
```

方案二：mapred-site.xml中设置Map和Reduce任务的内存配置如下：(value中实际配置的内存需要根据自己机器内存大小及应用情况进行修改)

```
<property>
　　<name>mapreduce.map.memory.mb</name>
　　<value>1536</value>
</property>
<property>
　　<name>mapreduce.map.java.opts</name>
　　<value>-Xmx1024M</value>
</property>
<property>
　　<name>mapreduce.reduce.memory.mb</name>
　　<value>3072</value>
</property>
<property>
　　<name>mapreduce.reduce.java.opts</name>
　　<value>-Xmx2560M</value>
</property>
```

